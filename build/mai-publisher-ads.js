(()=>{window.pbjs=window.pbjs||{que:[]},window.googletag=window.googletag||{},googletag.cmd=googletag.cmd||[];const e=maiPubAdsVars.ads,t=[],i=[],a=maiPubAdsVars.gamBase,o=maiPubAdsVars.gamBaseClient,s=maiPubAdsVars.targets.refresh,n={},r=5e3,d=6e3,c=window.location.search.includes("dfpdeb")||window.location.search.includes("maideb")||window.location.search.includes("pbjs_debug=true"),m=maiPubAdsVars.debug,l={prebid:{},amazon:{},timeouts:[]},u=Boolean(maiPubAdsVars.consent),g=maiPubAdsVars.ppid,p=function(){let e=!1;return e=document.cookie.match(/(?:^|;)\s*maipub_consent=([^;]*)(?:;|$)/),e=!(!e||!e[1])&&e[1],e||(e=localStorage.getItem("maipub_consent")),Boolean(e)}(),b=function(){const e=function(){const e=document.cookie.match(/(?:^|;)\s*maipub_ppid=([^;]*)(?:;|$)/);return e?.[1]||""}(),t=localStorage.getItem("maipub_ppid");return e||t||""}();let f=Date.now(),P=u||p,h="",v=!1,S=!1,A=!1;if(z("v226"),g?(h=g,z(`Using server-side PPID: ${h}`)):b&&(h=b,z(`Using local PPID: ${h}`)),maiPubAdsVars.amazonUAM&&(function(e,t,i,a,o,s,n){function r(i,a){t[e]._Q.push([i,a])}t[e]||(t[e]={init:function(){r("i",arguments)},fetchBids:function(){r("f",arguments)},setDisplayBids:function(){},targetingKeys:function(){return[]},_Q:[]},(s=i.createElement(a)).async=!0,s.src="//c.amazon-adsystem.com/aax2/apstag.js",(n=i.getElementsByTagName(a)[0]).parentNode.insertBefore(s,n))}("apstag",window,document,"script"),apstag.init({pubID:"79166f25-5776-4c3e-9537-abad9a584b43",adServer:"googletag",schain:{complete:1,ver:"1.0",nodes:[{asi:"bizbudding.com",sid:maiPubAdsVars.sellersId,hp:1,name:maiPubAdsVars.sellersName,domain:maiPubAdsVars.domain}]}})),maiPubAdsVars.magnite&&(maiPubAdsVars.ortb2.mobile=parseInt(maiPubAdsVars.ortb2.mobile),maiPubAdsVars.ortb2.privacypolicy=parseInt(maiPubAdsVars.ortb2.privacypolicy),maiPubAdsVars.ortb2.cattax=parseInt(maiPubAdsVars.ortb2.cattax),maiPubAdsVars.ortb2.content.cattax=parseInt(maiPubAdsVars.ortb2.content.cattax),pbjs.que.push((function(){const e={bidderTimeout:r,enableTIDs:!0,ortb2:maiPubAdsVars.ortb2};h&&(e.userSync={userIds:[{name:"pubProvidedId",params:{eids:[{source:maiPubAdsVars.domain,uids:[{id:h,atype:1}]}]}}]}),z("pbjsConfig",e),pbjs.setConfig(e),pbjs.onEvent("bidResponse",(function(e){l.prebid[e.bidder]={value:e.cpm,size:e.size,adUnitCode:e.adUnitCode,timeToRespond:e.timeToRespond+"ms"},z(`Prebid bid received from ${e.bidder}`,e)})),pbjs.onEvent("bidTimeout",(function(e){e.forEach((e=>{l.timeouts.push({bidder:e.bidder,adUnitCode:e.adUnitCode,timeout:r+"ms"})})),z("Bid timeout occurred:",e)})),pbjs.onEvent("auctionEnd",(function(e){z("Prebid auction ended:",e,{prebid:l.prebid,timeouts:l.timeouts,timing:{totalTime:Date.now()-f+"ms",bidderTimeout:r+"ms",fallbackTimeout:d+"ms"}})}))}))),"function"==typeof __tcfapi){const e=setTimeout((()=>{S||(z("CMP timeout, proceeding with initialization"),S=!0,I())}),2e3);try{__tcfapi("addEventListener",2,((t,i)=>{S||!t||"tcloaded"!==t.eventStatus&&"useractioncomplete"!==t.eventStatus||(S=!0,P=Boolean(i),clearTimeout(e),z(`CMP loaded, proceeding with initialization: ${i}`,t),I())}))}catch(t){z("CMP error:",t),clearTimeout(e),S=!0,I()}}else S=!0,I();if(maiPubAdsVars.matomo.enabled&&maiPubAdsVars.shouldTrack){const e=setTimeout((()=>{A||(z("Matomo timeout, proceeding with initialization"),A=!0,I())}),2e3);if(h)A=!0,clearTimeout(e),z(`Skipping Matomo initialization, using existing PPID: ${h}`),I();else if("undefined"!=typeof Matomo)try{const t=Matomo.getAsyncTracker();if(t){const i=t.getVisitorId();i&&V(i).then((t=>{h=t,A=!0,clearTimeout(e),z(`Matomo already initialized, generated PPID from visitor ID: ${h}`),I()})).catch((t=>{z("Error generating PPID from Matomo visitor ID:",t),V().then((t=>{h=t,A=!0,clearTimeout(e),z(`Matomo already initialized, generated random PPID after generation error: ${h}`),I()}))}))}}catch(t){z("Error accessing Matomo:",t),V().then((t=>{h=t,A=!0,clearTimeout(e),z(`Matomo already initialized, generated random PPID after catching error: ${h}`),I()}))}else z("Matomo not initialized, waiting for analytics init event"),document.addEventListener("maiPublisherAnalyticsInit",(function(t){V(t.detail.tracker.getVisitorId()).then((t=>{h=t,A=!0,clearTimeout(e),z(`Matomo async event fired, generated PPID from visitor ID: ${h}`),I()}))}),{once:!0})}else A=!0,maiPubAdsVars.matomo.enabled?maiPubAdsVars.shouldTrack||z("Matomo enabled but should not track"):z("Matomo disabled"),I();function I(){if(!S&&"function"==typeof __tcfapi||!A&&maiPubAdsVars.matomo.enabled){const e=[];return S||"function"!=typeof __tcfapi||e.push("CMP"),!A&&maiPubAdsVars.matomo.enabled&&e.push("Matomo"),void z("GAM not initialized, waiting for "+e.join(" and "))}h?(z(`Initializing GAM with ppid: ${h}`),y()):V().then((e=>{h=e,z(`Generated random PPID: ${h}`),z(`Initializing GAM with ppid: ${h}`),y()}))}function y(){if(P===u&&P===p||function(e){z(`Storing consent in cookie and session storage: ${e}`),document.cookie=`maipub_consent=${e};path=/;max-age=31104000;SameSite=Lax;Secure`,localStorage.setItem("maipub_consent",e)}(P),!h||h===g&&b&&h===b||function(e){P?(z(`Storing PPID in cookie: ${e}`),document.cookie=`maipub_ppid=${e};path=/;max-age=31104000;SameSite=Lax;Secure`):getCookiePpid()&&(z("No consent, removing PPID from cookie"),document.cookie="maipub_ppid=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT;SameSite=Lax;Secure"),z(`Storing PPID in session storage: ${e}`),localStorage.setItem("maipub_ppid",e)}(h),maiPubAdsVars.dcSeg){const e=document.createElement("script");e.async=!0,e.id="google-pcd-tag",e.className="mai-pcd-tag",e.src="https://pagead2.googlesyndication.com/pagead/js/pcd.js";let t="";maiPubAdsVars.dcSeg.forEach((e=>{t+=`dc_seg=${e};`}));let i=`dc_iu=/${maiPubAdsVars.bbNetworkCode}/DFPAudiencePixel;${t}gd=${maiPubAdsVars.domainHashed}`;h&&(i+=`;ppid=${h}`),e.setAttribute("data-audience-pixel",i),document.head.appendChild(e)}googletag.cmd.push((()=>{try{maiPubAdsVars.targets&&Object.keys(maiPubAdsVars.targets).forEach((e=>{googletag.pubads().setTargeting(e,maiPubAdsVars.targets[e].toString())})),googletag.pubads().setCentering(!0),googletag.pubads().disableInitialLoad(),googletag.pubads().enableSingleRequest(),h&&(z("Setting googletag PPID:",h),googletag.pubads().setPublisherProvidedId(h)),googletag.enableServices(),maiPubAdsVars.loadDelay?window.addEventListener("load",(()=>{setTimeout(w,maiPubAdsVars.loadDelay)}),{once:!0}):"loading"===document.readyState?document.addEventListener("DOMContentLoaded",w,{once:!0}):w(),googletag.pubads().addEventListener("slotRenderEnded",(e=>{const t=e.slot;if(!T(t))return;const i=t.getSlotElementId();n[i].processing=!1,n[i].lastRefreshTime=Date.now()})),googletag.pubads().addEventListener("slotError",(function(e){const t=e.slot;if(!T(t))return;const i=t.getSlotElementId();n[i].processing=!1,n[i].lastRefreshTime=Date.now()})),googletag.pubads().addEventListener("slotVisibilityChanged",(e=>{const t=e.slot;if(!T(t))return;const i=t.getSlotElementId(),a=e.inViewPercentage>5;n[i].visible=a,z(`Slot ${i} visibility: (${e.inViewPercentage}%)`)}))}catch(e){z("Error initializing GAM:",e)}}))}function w(){const u=new IntersectionObserver(((u,g)=>{const p=[];u.forEach((r=>{const d=r.target.getAttribute("id"),m=d.replace("mai-ad-",""),l=function(n){const r=(e?.[n]?.context&&"client"===e[n].context?o:a)+e[n].id,d="mai-ad-"+n,c=i.find((e=>d==e.getSlotElementId()));return c?(z("Slot already defined:",c),c):function(a,o){const n=googletag.defineSlot(a,e[o].sizes,"mai-ad-"+o);return googletag.display("mai-ad-"+o),t.push(a),i.push(n),z(`defineSlot() & display(): mai-ad-${o}`),n.setTargeting("refresh",s),e[o].targets&&Object.keys(e[o].targets).forEach((t=>{n.setTargeting(t,e[o].targets[t])})),e[o].splitTest&&"rand"===e[o].splitTest&&n.setTargeting("st",Math.floor(100*Math.random())),n.addService(googletag.pubads()),n.defineSizeMapping(googletag.sizeMapping().addSize([1024,768],e[o].sizesDesktop).addSize([728,480],e[o].sizesTablet).addSize([0,0],e[o].sizesMobile).build()),n}(r,n)}(m);n[d]||(n[d]={processing:!1,visible:!1,lastRefreshTime:0}),n[d].processing||(r.isIntersecting?(n[d].visible=!0,c&&(r.target.style.outline="2px dashed red",r.target.setAttribute("data-label",m)),p.push(l)):n[d].visible=!1)})),p.length&&function(t){t.forEach((e=>{const t=e.getSlotElementId();n[t].processing=!0})),z(`Requesting slots: ${t.map((e=>e.getSlotElementId())).join(", ")}`);const i={adserverRequestSent:!1,dmBidsReceived:!maiPubAdsVars.magnite,apsBidsReceived:!maiPubAdsVars.amazonUAM},o=function(){i.adserverRequestSent?z("Adserver request already sent, skipping. State:",{dmBidsReceived:i.dmBidsReceived,apsBidsReceived:i.apsBidsReceived,slots:slotsToRefreshNow.map((e=>e.getSlotElementId()))}):(i.adserverRequestSent=!0,z("Sending adserver request for slots:",t.map((e=>e.getSlotElementId()))),function(e){z(`Refreshing ${e.length} slots: ${e.map((e=>e.getSlotElementId())).join(", ")}`),googletag.pubads().refresh(e,{changeCorrelator:!1})}(t))};if(maiPubAdsVars.magnite&&pbjs.que.push((function(){const e=Date.now();pbjs.rp.requestBids({gptSlotObjects:t,timeout:r,bidsBackHandler:function(){pbjs.setTargetingForGPTAsync&&pbjs.setTargetingForGPTAsync(t.map((e=>e.getSlotElementId()))),i.dmBidsReceived=!0;const a=Date.now()-e;z(`Prebid response time: ${a}ms`),z("Prebid bids received:",{prebid:l.prebid,timeouts:l.timeouts,timing:{totalTime:Date.now()-f+"ms",bidderTimeout:r+"ms",fallbackTimeout:d+"ms",responseTime:a+"ms"}}),i.apsBidsReceived&&(z("Sending adserver request after Prebid bids"),o())}})})),maiPubAdsVars.amazonUAM){const s=t.filter((t=>{const i=t.getSlotElementId().replace("mai-ad-","");return!(1===e[i].sizes.length&&"fluid"===e[i].sizes[0])&&"client"!==e[i].context})).map((t=>{const i=t.getSlotElementId(),o=i.replace("mai-ad-","");return{slotID:i,slotName:a+e[o].id,sizes:e[o].sizes}}));if(s.length){const e={slots:s,timeout:r,params:{adRefresh:"1"}};z("amazonConfig",e);const t=Date.now();apstag.fetchBids(e,(function(e){const a=Date.now()-t;z(`Amazon response time: ${a}ms`),e.forEach((e=>{l.amazon[e.slotID]={value:e.amznbid,size:e.size,responseTime:a+"ms",error:e.error||null}})),e.length?z("Amazon bids received:",l.amazon):z("No Amazon bids received."),apstag.setDisplayBids(),i.apsBidsReceived=!0,i.dmBidsReceived&&(z(`Sending adserver request with amazon fetch: ${s.map((e=>e.slotID.replace("mai-ad-",""))).join(", ")}`,s),o()),(c||m)&&e.forEach((e=>{e.error&&z("apstag.fetchBids error:",e)}))}))}else i.apsBidsReceived=!0,i.dmBidsReceived&&(z(`Sending adserver request without amazon slots to fetch: ${t.map((e=>e.getSlotElementId())).join(", ")}`,t),o())}maiPubAdsVars.magnite&&maiPubAdsVars.amazonUAM||(z(`Sending adserver request with GAM: ${t.map((e=>e.getSlotElementId())).join(", ")}`,t),o()),setTimeout((()=>{const e={adserverRequestSent:i.adserverRequestSent,dmBidsReceived:i.dmBidsReceived,apsBidsReceived:i.apsBidsReceived,prebidBids:l.prebid,amazonBids:l.amazon,timeouts:l.timeouts,timing:{totalTime:Date.now()-f,bidderTimeout:r,fallbackTimeout:d}};i.adserverRequestSent||z("refresh() with failsafe timeout. Debug data:",e),o()}),d)}(p)}),{root:null,rootMargin:"600px 0px 600px 0px",threshold:0});document.querySelectorAll(".mai-ad-unit").forEach((e=>{u.observe(e)}))}function T(e){return e&&t.includes(e.getAdUnitPath())}async function V(e=""){if(v)return new Promise((e=>{const t=setInterval((()=>{v||(clearInterval(t),e(h))}),100)}));v=!0;try{let t=String(e||"");if(!t){if(!window.crypto||!window.crypto.subtle)throw new Error("Web Crypto API not available");t="function"==typeof crypto.randomUUID?crypto.randomUUID():Array.from(crypto.getRandomValues(new Uint8Array(16))).map((e=>e.toString(16).padStart(2,"0"))).join("")}const i=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")}catch(e){return z("Error transforming ppid:",e),null}finally{v=!1}}function z(...e){if(!c&&!m)return;let t="maipub ";const i=Date.now(),a=(new Date).toLocaleTimeString("en-US",{hour12:!0});t+=f===i?"start":i-f+"ms",console.log(`${t} ${a}`,e)}})();
//# sourceMappingURL=mai-publisher-ads.js.map