(()=>{window.pbjs=window.pbjs||{que:[]},window.googletag=window.googletag||{},googletag.cmd=googletag.cmd||[];const e=maiPubAdsVars.ads,t=[],a=[],i=maiPubAdsVars.gamBase,o=maiPubAdsVars.gamBaseClient,n=maiPubAdsVars.targets.refresh,s={},r=5e3,d=window.location.search.includes("dfpdeb")||window.location.search.includes("maideb")||window.location.search.includes("pbjs_debug=true"),c=maiPubAdsVars.debug,l=Boolean(maiPubAdsVars.consent),m=maiPubAdsVars.ppid,u=function(){let e=!1;return e=document.cookie.match(/(?:^|;)\s*maipub_consent=([^;]*)(?:;|$)/),e=!(!e||!e[1])&&e[1],e||(e=localStorage.getItem("maipub_consent")),Boolean(e)}(),g=function(){const e=function(){const e=document.cookie.match(/(?:^|;)\s*maipub_ppid=([^;]*)(?:;|$)/);return e?.[1]||""}(),t=localStorage.getItem("maipub_ppid");return e||t||""}();let p=Date.now(),b=l||u,f="",h=!1,P=!1,S=!1;if(T("v227"),m?(f=m,T(`Using server-side PPID: ${f}`)):g&&(f=g,T(`Using local PPID: ${f}`)),maiPubAdsVars.amazonUAM&&(function(e,t,a,i,o,n,s){function r(a,i){t[e]._Q.push([a,i])}t[e]||(t[e]={init:function(){r("i",arguments)},fetchBids:function(){r("f",arguments)},setDisplayBids:function(){},targetingKeys:function(){return[]},_Q:[]},(n=a.createElement(i)).async=!0,n.src="//c.amazon-adsystem.com/aax2/apstag.js",(s=a.getElementsByTagName(i)[0]).parentNode.insertBefore(n,s))}("apstag",window,document,"script"),apstag.init({pubID:"79166f25-5776-4c3e-9537-abad9a584b43",adServer:"googletag",schain:{complete:1,ver:"1.0",nodes:[{asi:"bizbudding.com",sid:maiPubAdsVars.sellersId,hp:1,name:maiPubAdsVars.sellersName,domain:maiPubAdsVars.domain}]}})),maiPubAdsVars.magnite&&(maiPubAdsVars.ortb2.mobile=parseInt(maiPubAdsVars.ortb2.mobile),maiPubAdsVars.ortb2.privacypolicy=parseInt(maiPubAdsVars.ortb2.privacypolicy),maiPubAdsVars.ortb2.cattax=parseInt(maiPubAdsVars.ortb2.cattax),maiPubAdsVars.ortb2.content.cattax=parseInt(maiPubAdsVars.ortb2.content.cattax),pbjs.que.push((function(){const e={bidderTimeout:r,enableTIDs:!0,ortb2:maiPubAdsVars.ortb2};f&&(e.userSync={userIds:[{name:"pubProvidedId",params:{eids:[{source:maiPubAdsVars.domain,uids:[{id:f,atype:1}]}]}}]}),T("pbjsConfig",e),pbjs.setConfig(e)}))),"function"==typeof __tcfapi){const e=setTimeout((()=>{P||(T("CMP timeout, proceeding with initialization"),P=!0,A())}),2e3);try{__tcfapi("addEventListener",2,((t,a)=>{P||!t||"tcloaded"!==t.eventStatus&&"useractioncomplete"!==t.eventStatus||(P=!0,b=Boolean(a),clearTimeout(e),T(`CMP loaded, proceeding with initialization: ${a}`,t),A())}))}catch(t){T("CMP error:",t),clearTimeout(e),P=!0,A()}}else P=!0,A();if(maiPubAdsVars.matomo.enabled&&maiPubAdsVars.shouldTrack){const e=setTimeout((()=>{S||(T("Matomo timeout, proceeding with initialization"),S=!0,A())}),2e3);if(f)S=!0,clearTimeout(e),T(`Skipping Matomo initialization, using existing PPID: ${f}`),A();else if("undefined"!=typeof Matomo)try{const t=Matomo.getAsyncTracker();if(t){const a=t.getVisitorId();a&&V(a).then((t=>{f=t,S=!0,clearTimeout(e),T(`Matomo already initialized, generated PPID from visitor ID: ${f}`),A()})).catch((t=>{T("Error generating PPID from Matomo visitor ID:",t),V().then((t=>{f=t,S=!0,clearTimeout(e),T(`Matomo already initialized, generated random PPID after generation error: ${f}`),A()}))}))}}catch(t){T("Error accessing Matomo:",t),V().then((t=>{f=t,S=!0,clearTimeout(e),T(`Matomo already initialized, generated random PPID after catching error: ${f}`),A()}))}else T("Matomo not initialized, waiting for analytics init event"),document.addEventListener("maiPublisherAnalyticsInit",(function(t){V(t.detail.tracker.getVisitorId()).then((t=>{f=t,S=!0,clearTimeout(e),T(`Matomo async event fired, generated PPID from visitor ID: ${f}`),A()}))}),{once:!0})}else S=!0,maiPubAdsVars.matomo.enabled?maiPubAdsVars.shouldTrack||T("Matomo enabled but should not track"):T("Matomo disabled"),A();function A(){if(!P&&"function"==typeof __tcfapi||!S&&maiPubAdsVars.matomo.enabled){const e=[];return P||"function"!=typeof __tcfapi||e.push("CMP"),!S&&maiPubAdsVars.matomo.enabled&&e.push("Matomo"),void T("GAM not initialized, waiting for "+e.join(" and "))}f?(T(`Initializing GAM with ppid: ${f}`),v()):V().then((e=>{f=e,T(`Generated random PPID: ${f}`),T(`Initializing GAM with ppid: ${f}`),v()}))}function v(){if(b===l&&b===u||function(e){T(`Storing consent in cookie and session storage: ${e}`),document.cookie=`maipub_consent=${e};path=/;max-age=31104000;SameSite=Lax;Secure`,localStorage.setItem("maipub_consent",e)}(b),!f||f===m&&g&&f===g||function(e){b?(T(`Storing PPID in cookie: ${e}`),document.cookie=`maipub_ppid=${e};path=/;max-age=31104000;SameSite=Lax;Secure`):getCookiePpid()&&(T("No consent, removing PPID from cookie"),document.cookie="maipub_ppid=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT;SameSite=Lax;Secure"),T(`Storing PPID in session storage: ${e}`),localStorage.setItem("maipub_ppid",e)}(f),maiPubAdsVars.dcSeg){const e=document.createElement("script");e.async=!0,e.id="google-pcd-tag",e.className="mai-pcd-tag",e.src="https://pagead2.googlesyndication.com/pagead/js/pcd.js";let t="";maiPubAdsVars.dcSeg.forEach((e=>{t+=`dc_seg=${e};`}));let a=`dc_iu=/${maiPubAdsVars.bbNetworkCode}/DFPAudiencePixel;${t}gd=${maiPubAdsVars.domainHashed}`;f&&(a+=`;ppid=${f}`),e.setAttribute("data-audience-pixel",a),document.head.appendChild(e)}googletag.cmd.push((()=>{try{maiPubAdsVars.targets&&Object.keys(maiPubAdsVars.targets).forEach((e=>{googletag.pubads().setTargeting(e,maiPubAdsVars.targets[e].toString())})),googletag.pubads().setCentering(!0),googletag.pubads().disableInitialLoad(),googletag.pubads().enableSingleRequest(),f&&(T("Setting googletag PPID:",f),googletag.pubads().setPublisherProvidedId(f)),googletag.enableServices(),maiPubAdsVars.loadDelay?window.addEventListener("load",(()=>{setTimeout(I,maiPubAdsVars.loadDelay)}),{once:!0}):"loading"===document.readyState?document.addEventListener("DOMContentLoaded",I,{once:!0}):I(),googletag.pubads().addEventListener("slotRenderEnded",(e=>{const t=e.slot;if(!w(t))return;const a=t.getSlotElementId();s[a].processing=!1,s[a].lastRefreshTime=Date.now()})),googletag.pubads().addEventListener("slotError",(function(e){const t=e.slot;if(!w(t))return;const a=t.getSlotElementId();s[a].processing=!1,s[a].lastRefreshTime=Date.now()})),googletag.pubads().addEventListener("slotVisibilityChanged",(e=>{const t=e.slot;if(!w(t))return;const a=t.getSlotElementId(),i=e.inViewPercentage>5;s[a].visible=i,i&&y([t])}))}catch(e){T("Error initializing GAM:",e)}}))}function I(){const r=new IntersectionObserver(((r,c)=>{const l=[];r.forEach((r=>{const c=r.target.getAttribute("id"),m=c.replace("mai-ad-",""),u=function(s){const r=(e?.[s]?.context&&"client"===e[s].context?o:i)+e[s].id,d="mai-ad-"+s,c=a.find((e=>d==e.getSlotElementId()));return c||function(i,o){const s=googletag.defineSlot(i,e[o].sizes,"mai-ad-"+o);return googletag.display("mai-ad-"+o),t.push(i),a.push(s),T(`defineSlot() & display(): mai-ad-${o}`),s.setTargeting("refresh",n),e[o].targets&&Object.keys(e[o].targets).forEach((t=>{s.setTargeting(t,e[o].targets[t])})),e[o].splitTest&&"rand"===e[o].splitTest&&s.setTargeting("st",Math.floor(100*Math.random())),s.addService(googletag.pubads()),s.defineSizeMapping(googletag.sizeMapping().addSize([1024,768],e[o].sizesDesktop).addSize([728,480],e[o].sizesTablet).addSize([0,0],e[o].sizesMobile).build()),s}(r,s)}(m);s[c]||(s[c]={processing:!1,visible:!1,lastRefreshTime:0}),s[c].processing||(r.isIntersecting?(s[c].visible=!0,d&&(r.target.style.outline="2px dashed red",r.target.setAttribute("data-label",m)),l.push(u)):s[c].visible=!1)})),l.length&&y(l)}),{root:null,rootMargin:"600px 0px 600px 0px",threshold:0});document.querySelectorAll(".mai-ad-unit").forEach((e=>{r.observe(e)}))}function y(t){T(`Temp maybe requesting slots: ${t.map((e=>e.getSlotElementId())).join(", ")}`);const a=t.filter((e=>{const t=e.getSlotElementId();return s[t].processing?(T(`Skipping request for ${t} - already being processed`),!1):s[t].visible?!(s[t].lastRefreshTime&&now-s[t].lastRefreshTime<32e3&&(T(`Skipping request for ${t} - too soon`),1)):(T(`Skipping request for ${t} - not visible`),!1)}));T(`Temp requesting slots: ${a.map((e=>e.getSlotElementId())).join(", ")}`),function(t){t.forEach((e=>{const t=e.getSlotElementId();s[t].processing=!0})),T(`Requesting slots: ${t.map((e=>e.getSlotElementId())).join(", ")}`);const a={adserverRequestSent:!1,prebidBidsReceived:!maiPubAdsVars.magnite,amazonBidsReceived:!maiPubAdsVars.amazonUAM},o=function(){a.adserverRequestSent?T("Adserver request already sent, skipping. State:",{prebidBidsReceived:a.prebidBidsReceived,amazonBidsReceived:a.amazonBidsReceived,slots:slotsToRefreshNow.map((e=>e.getSlotElementId()))}):(a.adserverRequestSent=!0,T(`Sending adserver request for slots: ${t.map((e=>e.getSlotElementId())).join(", ")}`),function(e){T(`Refreshing ${e.length} ${1===e.length?"slot":"slots"}: ${e.map((e=>e.getSlotElementId())).join(", ")}`),googletag.pubads().refresh(e,{changeCorrelator:!1})}(t))};if(maiPubAdsVars.magnite&&pbjs.que.push((function(){const e=Date.now();pbjs.rp.requestBids({gptSlotObjects:t,timeout:r,callback:function(i,n,s){pbjs.setTargetingForGPTAsync&&pbjs.setTargetingForGPTAsync(t.map((e=>e.getSlotElementId()))),a.prebidBidsReceived=!0,T(`Prebid response time: ${Date.now()-e}ms`,{bids:i,timedOut:n,auctionId:s}),a.amazonBidsReceived&&(T("Sending adserver request after Prebid bids"),o())}})})),maiPubAdsVars.amazonUAM){const n=t.filter((t=>{const a=t.getSlotElementId().replace("mai-ad-","");return!(1===e[a].sizes.length&&"fluid"===e[a].sizes[0])&&"client"!==e[a].context})).map((t=>{const a=t.getSlotElementId(),o=a.replace("mai-ad-","");return{slotID:a,slotName:i+e[o].id,sizes:e[o].sizes}}));if(n.length){const e={slots:n,timeout:r,params:{adRefresh:"1"}};T("amazonConfig",e);const t=Date.now();apstag.fetchBids(e,(function(e){T(`Amazon response time: ${Date.now()-t}ms`,e),apstag.setDisplayBids(),a.amazonBidsReceived=!0,a.prebidBidsReceived&&(T(`Sending adserver request with amazon fetch: ${n.map((e=>e.slotID.replace("mai-ad-",""))).join(", ")}`,n),o()),(d||c)&&e.forEach((e=>{e.error&&T("apstag.fetchBids error:",e)}))}))}else a.amazonBidsReceived=!0,a.prebidBidsReceived&&(T(`Sending adserver request without amazon slots to fetch: ${t.map((e=>e.getSlotElementId())).join(", ")}`,t),o())}maiPubAdsVars.magnite&&maiPubAdsVars.amazonUAM||(T(`Sending adserver request with GAM: ${t.map((e=>e.getSlotElementId())).join(", ")}`,t),o()),setTimeout((()=>{a.adserverRequestSent||(T("refresh() with failsafe timeout. Debug data:",{adserverRequestSent:a.adserverRequestSent,dmBidsReceived:a.dmBidsReceived,apsBidsReceived:a.apsBidsReceived,timing:{totalTime:Date.now()-p,bidderTimeout:r,fallbackTimeout:6e3}}),o())}),6e3)}(a)}function w(e){return e&&t.includes(e.getAdUnitPath())}async function V(e=""){if(h)return new Promise((e=>{const t=setInterval((()=>{h||(clearInterval(t),e(f))}),100)}));h=!0;try{let t=String(e||"");if(!t){if(!window.crypto||!window.crypto.subtle)throw new Error("Web Crypto API not available");t="function"==typeof crypto.randomUUID?crypto.randomUUID():Array.from(crypto.getRandomValues(new Uint8Array(16))).map((e=>e.toString(16).padStart(2,"0"))).join("")}const a=(new TextEncoder).encode(t),i=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(i)).map((e=>e.toString(16).padStart(2,"0"))).join("")}catch(e){return T("Error transforming ppid:",e),null}finally{h=!1}}function T(...e){if(!d&&!c)return;let t="maipub ";const a=Date.now(),i=(new Date).toLocaleTimeString("en-US",{hour12:!0});t+=p===a?"start":a-p+"ms",console.log(`${t} ${i}`,e)}})();
//# sourceMappingURL=mai-publisher-ads.js.map