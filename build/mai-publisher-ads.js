(()=>{window.pbjs=window.pbjs||{que:[]},window.googletag=window.googletag||{},googletag.cmd=googletag.cmd||[];const e=maiPubAdsVars.ads,t=[],i=[],a=maiPubAdsVars.gamBase,o=maiPubAdsVars.gamBaseClient,s=maiPubAdsVars.targets.refresh,n={},r={},d={},c=5e3,l=6e3,m=window.location.search.includes("dfpdeb")||window.location.search.includes("maideb")||window.location.search.includes("pbjs_debug=true"),u=maiPubAdsVars.debug,g={prebid:{},amazon:{},timeouts:[]},p=Boolean(maiPubAdsVars.consent),b=maiPubAdsVars.ppid,f=function(){let e=!1;return e=document.cookie.match(/(?:^|;)\s*maipub_consent=([^;]*)(?:;|$)/),e=!(!e||!e[1])&&e[1],e||(e=localStorage.getItem("maipub_consent")),Boolean(e)}(),h=function(){const e=function(){const e=document.cookie.match(/(?:^|;)\s*maipub_ppid=([^;]*)(?:;|$)/);return e?.[1]||""}(),t=localStorage.getItem("maipub_ppid");return e||t||""}();let P=Date.now(),S=p||f,v="",A=!1,y=!1,I=!1;if(R("v225"),b?(v=b,R(`Using server-side PPID: ${v}`)):h&&(v=h,R(`Using local PPID: ${v}`)),maiPubAdsVars.amazonUAM&&(function(e,t,i,a,o,s,n){function r(i,a){t[e]._Q.push([i,a])}t[e]||(t[e]={init:function(){r("i",arguments)},fetchBids:function(){r("f",arguments)},setDisplayBids:function(){},targetingKeys:function(){return[]},_Q:[]},(s=i.createElement(a)).async=!0,s.src="//c.amazon-adsystem.com/aax2/apstag.js",(n=i.getElementsByTagName(a)[0]).parentNode.insertBefore(s,n))}("apstag",window,document,"script"),apstag.init({pubID:"79166f25-5776-4c3e-9537-abad9a584b43",adServer:"googletag",schain:{complete:1,ver:"1.0",nodes:[{asi:"bizbudding.com",sid:maiPubAdsVars.sellersId,hp:1,name:maiPubAdsVars.sellersName,domain:maiPubAdsVars.domain}]}})),maiPubAdsVars.magnite&&(maiPubAdsVars.ortb2.mobile=parseInt(maiPubAdsVars.ortb2.mobile),maiPubAdsVars.ortb2.privacypolicy=parseInt(maiPubAdsVars.ortb2.privacypolicy),maiPubAdsVars.ortb2.cattax=parseInt(maiPubAdsVars.ortb2.cattax),maiPubAdsVars.ortb2.content.cattax=parseInt(maiPubAdsVars.ortb2.content.cattax),pbjs.que.push((function(){const e={bidderTimeout:c,enableTIDs:!0,ortb2:maiPubAdsVars.ortb2};v&&(e.userSync={userIds:[{name:"pubProvidedId",params:{eids:[{source:maiPubAdsVars.domain,uids:[{id:v,atype:1}]}]}}]}),R("pbjsConfig",e),pbjs.setConfig(e),pbjs.onEvent("bidResponse",(function(e){g.prebid[e.bidder]={value:e.cpm,size:e.size,adUnitCode:e.adUnitCode,timeToRespond:e.timeToRespond+"ms"},R(`Prebid bid received from ${e.bidder}`,e)})),pbjs.onEvent("bidTimeout",(function(e){e.forEach((e=>{g.timeouts.push({bidder:e.bidder,adUnitCode:e.adUnitCode,timeout:c+"ms"})})),R("Bid timeout occurred:",e)})),pbjs.onEvent("auctionEnd",(function(e){R("Prebid auction ended:",e,{prebid:g.prebid,timeouts:g.timeouts,timing:{totalTime:Date.now()-P+"ms",bidderTimeout:c+"ms",fallbackTimeout:l+"ms"}})}))}))),"function"==typeof __tcfapi){const e=setTimeout((()=>{y||(R("CMP timeout, proceeding with initialization"),y=!0,w())}),2e3);try{__tcfapi("addEventListener",2,((t,i)=>{y||!t||"tcloaded"!==t.eventStatus&&"useractioncomplete"!==t.eventStatus||(y=!0,S=Boolean(i),clearTimeout(e),R(`CMP loaded, proceeding with initialization: ${i}`,t),w())}))}catch(t){R("CMP error:",t),clearTimeout(e),y=!0,w()}}else y=!0,w();if(maiPubAdsVars.matomo.enabled&&maiPubAdsVars.shouldTrack){const e=setTimeout((()=>{I||(R("Matomo timeout, proceeding with initialization"),I=!0,w())}),2e3);if(v)I=!0,clearTimeout(e),R(`Skipping Matomo initialization, using existing PPID: ${v}`),w();else if("undefined"!=typeof Matomo)try{const t=Matomo.getAsyncTracker();if(t){const i=t.getVisitorId();i&&V(i).then((t=>{v=t,I=!0,clearTimeout(e),R(`Matomo already initialized, generated PPID from visitor ID: ${v}`),w()})).catch((t=>{R("Error generating PPID from Matomo visitor ID:",t),V().then((t=>{v=t,I=!0,clearTimeout(e),R(`Matomo already initialized, generated random PPID after generation error: ${v}`),w()}))}))}}catch(t){R("Error accessing Matomo:",t),V().then((t=>{v=t,I=!0,clearTimeout(e),R(`Matomo already initialized, generated random PPID after catching error: ${v}`),w()}))}else R("Matomo not initialized, waiting for analytics init event"),document.addEventListener("maiPublisherAnalyticsInit",(function(t){V(t.detail.tracker.getVisitorId()).then((t=>{v=t,I=!0,clearTimeout(e),R(`Matomo async event fired, generated PPID from visitor ID: ${v}`),w()}))}),{once:!0})}else I=!0,maiPubAdsVars.matomo.enabled?maiPubAdsVars.shouldTrack||R("Matomo enabled but should not track"):R("Matomo disabled"),w();function w(){if(!y&&"function"==typeof __tcfapi||!I&&maiPubAdsVars.matomo.enabled){const e=[];return y||"function"!=typeof __tcfapi||e.push("CMP"),!I&&maiPubAdsVars.matomo.enabled&&e.push("Matomo"),void R("GAM not initialized, waiting for "+e.join(" and "))}v?(R(`Initializing GAM with ppid: ${v}`),$()):V().then((e=>{v=e,R(`Generated random PPID: ${v}`),R(`Initializing GAM with ppid: ${v}`),$()}))}function $(){if(S===p&&S===f||function(e){R(`Storing consent in cookie and session storage: ${e}`),document.cookie=`maipub_consent=${e};path=/;max-age=31104000;SameSite=Lax;Secure`,localStorage.setItem("maipub_consent",e)}(S),!v||v===b&&h&&v===h||function(e){S?(R(`Storing PPID in cookie: ${e}`),document.cookie=`maipub_ppid=${e};path=/;max-age=31104000;SameSite=Lax;Secure`):getCookiePpid()&&(R("No consent, removing PPID from cookie"),document.cookie="maipub_ppid=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT;SameSite=Lax;Secure"),R(`Storing PPID in session storage: ${e}`),localStorage.setItem("maipub_ppid",e)}(v),maiPubAdsVars.dcSeg){const e=document.createElement("script");e.async=!0,e.id="google-pcd-tag",e.className="mai-pcd-tag",e.src="https://pagead2.googlesyndication.com/pagead/js/pcd.js";let t="";maiPubAdsVars.dcSeg.forEach((e=>{t+=`dc_seg=${e};`}));let i=`dc_iu=/${maiPubAdsVars.bbNetworkCode}/DFPAudiencePixel;${t}gd=${maiPubAdsVars.domainHashed}`;v&&(i+=`;ppid=${v}`),e.setAttribute("data-audience-pixel",i),document.head.appendChild(e)}googletag.cmd.push((()=>{try{maiPubAdsVars.targets&&Object.keys(maiPubAdsVars.targets).forEach((e=>{googletag.pubads().setTargeting(e,maiPubAdsVars.targets[e].toString())})),googletag.pubads().setCentering(!0),googletag.pubads().disableInitialLoad(),googletag.pubads().enableSingleRequest(),v&&(R("Setting googletag PPID:",v),googletag.pubads().setPublisherProvidedId(v)),googletag.enableServices(),maiPubAdsVars.loadDelay?window.addEventListener("load",(()=>{setTimeout(z,maiPubAdsVars.loadDelay)}),{once:!0}):"loading"===document.readyState?document.addEventListener("DOMContentLoaded",z,{once:!0}):z(),googletag.pubads().addEventListener("slotVisibilityChanged",(e=>{const i=e.slot,a=i.getSlotElementId(),o=e.inViewPercentage>5;(function(e){return e&&t.includes(e.getAdUnitPath())})(i)&&(d[a]&&(delete d[a],n[a]=Date.now(),R(`Cleared processing flag for ${a} after slotVisibilityChanged`)),r[a]=o,R(`Slot ${a} visibility changed to ${o?"visible":"invisible"} (${e.inViewPercentage}%)`),o&&E(i,"slotVisibilityChanged"))}))}catch(e){R("Error initializing GAM:",e)}}))}async function V(e=""){if(A)return new Promise((e=>{const t=setInterval((()=>{A||(clearInterval(t),e(v))}),100)}));A=!0;try{let t=String(e||"");if(!t){if(!window.crypto||!window.crypto.subtle)throw new Error("Web Crypto API not available");t="function"==typeof crypto.randomUUID?crypto.randomUUID():Array.from(crypto.getRandomValues(new Uint8Array(16))).map((e=>e.toString(16).padStart(2,"0"))).join("")}const i=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-256",i);return Array.from(new Uint8Array(a)).map((e=>e.toString(16).padStart(2,"0"))).join("")}catch(e){return R("Error transforming ppid:",e),null}finally{A=!1}}function z(){const e=document.querySelectorAll('.mai-ad-unit[data-ap="atf"], .mai-ad-unit[data-ap="bs"]'),t=document.querySelectorAll('.mai-ad-unit:not([data-ap="atf"]):not([data-ap="bs"])');googletag.cmd.push((()=>{e.forEach((e=>{const t=e.getAttribute("id").replace("mai-ad-","");E(D(t),"ATF via DOMContentLoaded"),m&&(e.style.outline="2px dashed limegreen",e.setAttribute("data-label",t))}))}));const i=new IntersectionObserver(((e,t)=>{const i=[];e.forEach((e=>{if(!e.isIntersecting)return;const a=e.target.getAttribute("id").replace("mai-ad-","");m&&(e.target.style.outline="2px dashed red",e.target.setAttribute("data-label",a)),i.push(a),t.unobserve(e.target)})),i.length&&googletag.cmd.push((()=>{i.forEach((e=>E(D(e),"IntersectionObserver")))}))}),{root:null,rootMargin:"600px 0px 600px 0px",threshold:0});t.forEach((e=>{i.observe(e)}))}function D(n){let r=null;const d=(e?.[n]?.context&&"client"===e[n].context?o:a)+e[n].id,c="mai-ad-"+n,l=i.find((e=>c==e.getSlotElementId()));if(l)return R("Slot already defined:",l),l;const m=googletag.defineSlot(d,e[n].sizes,"mai-ad-"+n);return googletag.display("mai-ad-"+n),t.push(d),i.push(m),R("defineSlot() & display():",i),m.setTargeting("refresh",s),e[n].targets&&Object.keys(e[n].targets).forEach((t=>{m.setTargeting(t,e[n].targets[t])})),e[n].splitTest&&"rand"===e[n].splitTest&&m.setTargeting("st",Math.floor(100*Math.random())),m.addService(googletag.pubads()),m.defineSizeMapping(googletag.sizeMapping().addSize([1024,768],e[n].sizesDesktop).addSize([728,480],e[n].sizesTablet).addSize([0,0],e[n].sizesMobile).build()),r=m,r}function E(t,i){const o=t.getSlotElementId(),{shouldRefresh:s,timeUntilNextRefresh:n}=T(t);s?(R(`refreshed via ${i}: ${o}`,t),function(t,i=!1){R(`Display slots called with ${t.length} slots, force=${i}`),function(t,i){const o=i?t:t.filter((e=>{const{shouldRefresh:t,timeSinceLastRefresh:i}=T(e);if(!t)return R(`Skipping refresh of ${e.getSlotElementId()}, refreshed ${Math.floor(i/1e3)}s ago`),!1;const a=i&&1/0!==i?`${Math.floor(i/1e3)}s since last refresh`:"First display";return R(`Processing ${e.getSlotElementId()}, ${a}`),!0}));if(!o.length)return void R("No slots to refresh after filtering.");const s=o.filter((e=>{const t=e.getSlotElementId();return!d[t]||(R(`Skipping ${t} - already being processed`),!1)}));if(!s.length)return void R("No slots to process after filtering out already processing slots");s.forEach((e=>{const t=e.getSlotElementId();d[t]=Date.now(),R(`Set processing flag for ${t}`)})),R(`Processing ${s.length} slots:`,s.map((e=>e.getSlotElementId())));const n={adserverRequestSent:!1,dmBidsReceived:!maiPubAdsVars.magnite,apsBidsReceived:!maiPubAdsVars.amazonUAM},r=function(){n.adserverRequestSent?R("Adserver request already sent, skipping. State:",{dmBidsReceived:n.dmBidsReceived,apsBidsReceived:n.apsBidsReceived,slots:s.map((e=>e.getSlotElementId()))}):(n.adserverRequestSent=!0,R("Sending adserver request for slots:",s.map((e=>e.getSlotElementId()))),function(e){R(`Refreshing ${e.length} slots:`,e.map((e=>e.getSlotElementId()))),googletag.pubads().refresh(e,{changeCorrelator:!1})}(s))};if(maiPubAdsVars.magnite&&pbjs.que.push((function(){const e=Date.now();pbjs.rp.requestBids({gptSlotObjects:s,timeout:c,bidsBackHandler:function(){pbjs.setTargetingForGPTAsync&&pbjs.setTargetingForGPTAsync(s.map((e=>e.getSlotElementId()))),n.dmBidsReceived=!0;const t=Date.now()-e;R(`Prebid response time: ${t}ms`),R("Prebid bids received:",{prebid:g.prebid,timeouts:g.timeouts,timing:{totalTime:Date.now()-P+"ms",bidderTimeout:c+"ms",fallbackTimeout:l+"ms",responseTime:t+"ms"}}),n.apsBidsReceived&&(R("Sending adserver request after Prebid bids"),r())}})})),maiPubAdsVars.amazonUAM){const t=s.filter((t=>{const i=t.getSlotElementId().replace("mai-ad-","");return!(1===e[i].sizes.length&&"fluid"===e[i].sizes[0])&&"client"!==e[i].context})).map((t=>{const i=t.getSlotElementId(),o=i.replace("mai-ad-","");return{slotID:i,slotName:a+e[o].id,sizes:e[o].sizes}}));if(t.length){const e={slots:t,timeout:c,params:{adRefresh:"1"}};R("amazonConfig",e);const i=Date.now();apstag.fetchBids(e,(function(e){const a=Date.now()-i;R(`Amazon response time: ${a}ms`),e.forEach((e=>{g.amazon[e.slotID]={value:e.amznbid,size:e.size,responseTime:a+"ms",error:e.error||null}})),e.length?R("Amazon bids received:",g.amazon):R("No Amazon bids received."),apstag.setDisplayBids(),n.apsBidsReceived=!0,n.dmBidsReceived&&(R(`Sending adserver request with amazon fetch: ${t.map((e=>e.slotID.replace("mai-ad-",""))).join(", ")}`,t),r()),(m||u)&&e.forEach((e=>{e.error&&R("apstag.fetchBids error:",e)}))}))}else n.apsBidsReceived=!0,n.dmBidsReceived&&(R(`Sending adserver request without amazon slots to fetch: ${s.map((e=>e.getSlotElementId())).join(", ")}`,s),r())}maiPubAdsVars.magnite||maiPubAdsVars.amazonUAM||(R(`Sending adserver request with GAM: ${s.map((e=>e.getSlotElementId())).join(", ")}`,s),r()),setTimeout((()=>{const e={adserverRequestSent:n.adserverRequestSent,dmBidsReceived:n.dmBidsReceived,apsBidsReceived:n.apsBidsReceived,prebidBids:g.prebid,amazonBids:g.amazon,timeouts:g.timeouts,timing:{totalTime:Date.now()-P,bidderTimeout:c,fallbackTimeout:l}};n.adserverRequestSent||R("refresh() with failsafe timeout. Debug data:",e),r()}),l)}(t,i)}([t],!0)):r[o]&&n>0||R(`not refreshing ${o} because it's not visible or no valid timeUntilNextRefresh`)}function T(e,t=Date.now()){const i=e.getSlotElementId();if(d[i])return R(`Slot ${i} is already being processed, skipping refresh check`),{shouldRefresh:!1,timeSinceLastRefresh:0,timeUntilNextRefresh:0};const a=n[i];if(!a)return R(`Slot ${i} never refreshed, should refresh immediately`),{shouldRefresh:!0,timeSinceLastRefresh:1/0,timeUntilNextRefresh:0};const o=t-a,s=r[i]?o:0;return{shouldRefresh:s>=32e3,timeSinceLastRefresh:s,timeUntilNextRefresh:Math.max(0,32e3-o)}}function R(...e){if(!m&&!u)return;let t="maipub ";const i=Date.now(),a=(new Date).toLocaleTimeString("en-US",{hour12:!0});t+=P===i?"start":i-P+"ms",console.log(`${t} ${a}`,e)}setInterval((()=>{const e=Date.now(),t=Object.entries(d).filter((([t,i])=>e-i>3e4)).map((([e])=>e));t.length&&(R(`WARNING: Found ${t.length} stuck slots:`,t),t.forEach((e=>{delete d[e],R(`Cleared stuck processing flag for ${e}`)})))}),3e4)})();
//# sourceMappingURL=mai-publisher-ads.js.map