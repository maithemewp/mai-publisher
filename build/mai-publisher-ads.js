(()=>{window.pbjs=window.pbjs||{que:[]},window.googletag=window.googletag||{},googletag.cmd=googletag.cmd||[];const e=maiPubAdsVars.ads,t=[],a=[],i=maiPubAdsVars.gamBase,o=maiPubAdsVars.gamBaseClient,s="refresh",n=maiPubAdsVars.targets.refresh,d={},r={},c={},l=3e3,m=4e3,u=window.location.search.includes("dfpdeb")||window.location.search.includes("maideb")||window.location.search.includes("pbjs_debug=true"),g=maiPubAdsVars.debug,p={prebid:{},amazon:{},timeouts:[]},b=Boolean(maiPubAdsVars.consent),f=maiPubAdsVars.ppid,h=function(){let e=!1;return e=document.cookie.match(/(?:^|;)\s*maipub_consent=([^;]*)(?:;|$)/),e=!(!e||!e[1])&&e[1],e||(e=localStorage.getItem("maipub_consent")),Boolean(e)}(),P=function(){const e=T(),t=localStorage.getItem("maipub_ppid");return e||t||""}();let v=Date.now(),A=b||h,S="",y=!1,w=!1,I=!1;if(x("v214"),f?(S=f,x(`Using server-side PPID: ${S}`)):P&&(S=P,x(`Using local PPID: ${S}`)),maiPubAdsVars.amazonUAM&&(function(e,t,a,i,o,s,n){function d(a,i){t[e]._Q.push([a,i])}t[e]||(t[e]={init:function(){d("i",arguments)},fetchBids:function(){d("f",arguments)},setDisplayBids:function(){},targetingKeys:function(){return[]},_Q:[]},(s=a.createElement(i)).async=!0,s.src="//c.amazon-adsystem.com/aax2/apstag.js",(n=a.getElementsByTagName(i)[0]).parentNode.insertBefore(s,n))}("apstag",window,document,"script"),apstag.init({pubID:"79166f25-5776-4c3e-9537-abad9a584b43",adServer:"googletag",schain:{complete:1,ver:"1.0",nodes:[{asi:"bizbudding.com",sid:maiPubAdsVars.sellersId,hp:1,name:maiPubAdsVars.sellersName,domain:maiPubAdsVars.domain}]}})),"function"==typeof __tcfapi){const e=setTimeout((()=>{w||(x("CMP timeout, proceeding with initialization"),w=!0,V())}),1500);try{__tcfapi("addEventListener",2,((t,a)=>{w||!t||"tcloaded"!==t.eventStatus&&"useractioncomplete"!==t.eventStatus||(w=!0,A=Boolean(a),clearTimeout(e),x(`CMP loaded, proceeding with initialization: ${a}`,t),V())}))}catch(t){x("CMP error:",t),clearTimeout(e),w=!0,V()}}else w=!0,V();if(maiPubAdsVars.matomo.enabled&&maiPubAdsVars.shouldTrack){const e=setTimeout((()=>{I||(x("Matomo timeout, proceeding with initialization"),I=!0,V())}),1500);if("undefined"!=typeof Matomo)try{const t=Matomo.getAsyncTracker();if(t){const a=t.getVisitorId();a&&z(a).then((t=>{S=t,I=!0,clearTimeout(e),x(`Matomo already initialized, generated PPID from visitor ID: ${S}`),V()})).catch((t=>{x("Error generating PPID from Matomo visitor ID:",t),z().then((t=>{S=t,I=!0,clearTimeout(e),x(`Matomo already initialized, generated random PPID after generation error: ${S}`),V()}))}))}}catch(t){x("Error accessing Matomo:",t),z().then((t=>{S=t,I=!0,clearTimeout(e),x(`Matomo already initialized, generated random PPID after catching error: ${S}`),V()}))}else S?S&&(I=!0,clearTimeout(e),x(`Not waiting for Matomo, we have a local PPID: ${S}`),V()):(x("Matomo not initialized, waiting for analytics init event"),document.addEventListener("maiPublisherAnalyticsInit",(function(t){z(t.detail.tracker.getVisitorId()).then((t=>{S=t,I=!0,clearTimeout(e),x(`Matomo async event fired, generated PPID from visitor ID: ${S}`),V()}))}),{once:!0}))}else I=!0,maiPubAdsVars.matomo.enabled?maiPubAdsVars.shouldTrack||x("Matomo enabled but should not track"):x("Matomo disabled"),V();function V(){if(!w&&"function"==typeof __tcfapi||!I&&maiPubAdsVars.matomo.enabled){const e=[];return w||"function"!=typeof __tcfapi||e.push("CMP"),!I&&maiPubAdsVars.matomo.enabled&&e.push("Matomo"),void x("GAM not initialized, waiting for "+e.join(" and "))}S?(x(`Initializing GAM with ppid: ${S}`),E()):z().then((e=>{S=e,x(`Generated random PPID: ${S}`),x(`Initializing GAM with ppid: ${S}`),E()}))}function E(){if(A===b&&A===h||function(e){x(`Storing consent in cookie and session storage: ${e}`),document.cookie=`maipub_consent=${e};path=/;max-age=31104000;SameSite=Lax;Secure`,localStorage.setItem("maipub_consent",e)}(A),!S||S===f&&P&&S===P||function(e){A?(x(`Storing PPID in cookie: ${e}`),document.cookie=`maipub_ppid=${e};path=/;max-age=31104000;SameSite=Lax;Secure`):T()&&(x("No consent, removing PPID from cookie"),document.cookie="maipub_ppid=;path=/;expires=Thu, 01 Jan 1970 00:00:00 GMT;SameSite=Lax;Secure"),x(`Storing PPID in session storage: ${e}`),localStorage.setItem("maipub_ppid",e)}(S),maiPubAdsVars.dcSeg){const e=document.createElement("script");e.async=!0,e.id="google-pcd-tag",e.className="mai-pcd-tag",e.src="https://pagead2.googlesyndication.com/pagead/js/pcd.js";let t="";maiPubAdsVars.dcSeg.forEach((e=>{t+=`dc_seg=${e};`}));let a=`dc_iu=/${maiPubAdsVars.bbNetworkCode}/DFPAudiencePixel;${t}gd=${maiPubAdsVars.domainHashed}`;S&&(a+=`;ppid=${S}`),e.setAttribute("data-audience-pixel",a),document.head.appendChild(e)}googletag.cmd.push((()=>{try{maiPubAdsVars.targets&&Object.keys(maiPubAdsVars.targets).forEach((e=>{googletag.pubads().setTargeting(e,maiPubAdsVars.targets[e].toString())})),googletag.pubads().setCentering(!0),googletag.pubads().disableInitialLoad(),googletag.pubads().enableSingleRequest(),S&&(x("Setting googletag PPID:",S),googletag.pubads().setPublisherProvidedId(S)),googletag.enableServices(),maiPubAdsVars.loadDelay?window.addEventListener("load",(()=>{setTimeout(D,maiPubAdsVars.loadDelay)}),{once:!0}):"loading"===document.readyState?document.addEventListener("DOMContentLoaded",D,{once:!0}):D(),googletag.pubads().addEventListener("impressionViewable",(e=>{const t=e.slot,a=t.getSlotElementId();$(t)&&(d[a]=Date.now(),c[a]&&clearTimeout(c[a]),c[a]=setTimeout((()=>{x(`refreshed via impressionViewable: ${a}`,t),j([t])}),3e4))})),googletag.pubads().addEventListener("slotVisibilityChanged",(e=>{const t=e.slot,a=t.getSlotElementId(),i=e.inViewPercentage>5;if($(t)){if(i&&!r[a])r[a]=!0;else{if(i||!r[a])return;r[a]=!1}r[a]?!d?.[a]||d[a]&&Date.now()-d[a]<3e4||(x(`refreshed via slotVisibilityChanged: ${a}`,t),j([t])):clearTimeout(c[a])}})),googletag.pubads().addEventListener("slotRenderEnded",(t=>{if(!t.isEmpty)return;if(!M(t.slot))return;const a=t.slot.getSlotElementId().replace("mai-ad-","");e[a].context})),(u||g)&&(googletag.pubads().addEventListener("slotRequested",(e=>{x("slotRequested:",e.slot,e)})),googletag.pubads().addEventListener("slotResponseReceived",(e=>{x("slotResponseReceived:",e.slot,e)})),googletag.pubads().addEventListener("slotOnload",(e=>{x("slotOnload:",e.slot,e)})),googletag.pubads().addEventListener("slotRenderEnded",(e=>{x("slotRenderEnded:",e.slot,e)})))}catch(e){x("Error initializing GAM:",e)}}))}async function z(e=""){if(y)return new Promise((e=>{const t=setInterval((()=>{y||(clearInterval(t),e(S))}),100)}));y=!0;try{let t=String(e||"");if(!t){if(!window.crypto||!window.crypto.subtle)throw new Error("Web Crypto API not available");t="function"==typeof crypto.randomUUID?crypto.randomUUID():Array.from(crypto.getRandomValues(new Uint8Array(16))).map((e=>e.toString(16).padStart(2,"0"))).join("")}const a=(new TextEncoder).encode(t),i=await crypto.subtle.digest("SHA-256",a);return Array.from(new Uint8Array(i)).map((e=>e.toString(16).padStart(2,"0"))).join("")}catch(e){return x("Error transforming ppid:",e),null}finally{y=!1}}function T(){const e=document.cookie.match(/(?:^|;)\s*maipub_ppid=([^;]*)(?:;|$)/);return e?.[1]||""}function D(){const e=[],t=document.querySelectorAll('.mai-ad-unit[data-ap="atf"], .mai-ad-unit[data-ap="bs"]'),a=document.querySelectorAll('.mai-ad-unit:not([data-ap="atf"]):not([data-ap="bs"])');googletag.cmd.push((()=>{t.forEach((t=>{const a=t.getAttribute("id").replace("mai-ad-","");e.push(B(a)),u&&(t.style.outline="2px dashed limegreen",t.setAttribute("data-label",a))})),e.length&&R(e)}));const i=new IntersectionObserver(((e,t)=>{const a=[];e.forEach((e=>{if(!e.isIntersecting)return;const i=e.target.getAttribute("id").replace("mai-ad-","");u&&(e.target.style.outline="2px dashed red",e.target.setAttribute("data-label",i)),a.push(i),t.unobserve(e.target)})),a.length&&googletag.cmd.push((()=>{R(a.map((e=>B(e))))}))}),{root:null,rootMargin:"600px 0px 600px 0px",threshold:0});a.forEach((e=>{i.observe(e)}))}function B(d){let r=null;const c=(e?.[d]?.context&&"client"===e[d].context?o:i)+e[d].id,l="mai-ad-"+d,m=a.find((e=>l==e.getSlotElementId()));if(m)return x("Slot already defined:",m),m;const u=googletag.defineSlot(c,e[d].sizes,"mai-ad-"+d);return googletag.display("mai-ad-"+d),t.push(c),a.push(u),x("defineSlot() & display():",a),u.setTargeting(s,n),e[d].targets&&Object.keys(e[d].targets).forEach((t=>{u.setTargeting(t,e[d].targets[t])})),e[d].splitTest&&"rand"===e[d].splitTest&&u.setTargeting("st",Math.floor(100*Math.random())),u.addService(googletag.pubads()),u.defineSizeMapping(googletag.sizeMapping().addSize([1024,768],e[d].sizesDesktop).addSize([728,480],e[d].sizesTablet).addSize([0,0],e[d].sizesMobile).build()),r=u,r}function R(t){const a={adserverRequestSent:!1,dmBidsReceived:!1,apsBidsReceived:!1},o=function(){a.adserverRequestSent||(a.adserverRequestSent=!0,googletag.pubads().refresh(t))};if(maiPubAdsVars.magnite?(maiPubAdsVars.ortb2.mobile=parseInt(maiPubAdsVars.ortb2.mobile),maiPubAdsVars.ortb2.privacypolicy=parseInt(maiPubAdsVars.ortb2.privacypolicy),maiPubAdsVars.ortb2.cattax=parseInt(maiPubAdsVars.ortb2.cattax),maiPubAdsVars.ortb2.content.cattax=parseInt(maiPubAdsVars.ortb2.content.cattax),pbjs.que.push((function(){const e={bidderTimeout:l,enableTIDs:!0,ortb2:maiPubAdsVars.ortb2};S&&(e.userSync={userIds:[{name:"pubProvidedId",params:{eids:[{source:maiPubAdsVars.domain,uids:[{id:S,atype:1}]}]}}]}),x("pbjsConfig",e),pbjs.setConfig(e),pbjs.onEvent("bidResponse",(function(e){p.prebid[e.bidder]={value:e.cpm,size:e.size,adUnitCode:e.adUnitCode,timeToRespond:e.timeToRespond+"ms"},x(`Prebid bid received from ${e.bidder}`,e)})),pbjs.onEvent("bidTimeout",(function(e){e.forEach((e=>{p.timeouts.push({bidder:e.bidder,adUnitCode:e.adUnitCode,timeout:l+"ms"})})),x("Bid timeout occurred:",e)})),pbjs.onEvent("allBidsBack",(function(e){x("All bids back:",{bids:e,timeouts:p.timeouts,timing:{totalTime:Date.now()-v+"ms",bidderTimeout:l+"ms",fallbackTimeout:m+"ms"}})})),pbjs.rp.requestBids({gptSlotObjects:t,callback:function(){pbjs.setTargetingForGPTAsync(),a.dmBidsReceived=!0,x("All prebid responses:",p.prebid),a.apsBidsReceived&&(o(),x(`refresh() with prebid: ${t.map((e=>e.getSlotElementId())).join(", ")}`,t))}})}))):a.dmBidsReceived=!0,maiPubAdsVars.amazonUAM){const s=t.filter((t=>{const a=t.getSlotElementId().replace("mai-ad-","");return!(1===e[a].sizes.length&&"fluid"===e[a].sizes[0])&&"client"!==e[a].context})).map((t=>{const a=t.getSlotElementId(),o=a.replace("mai-ad-","");return{slotID:a,slotName:i+e[o].id,sizes:e[o].sizes}}));if(s.length){const e={slots:s,timeout:l,params:{adRefresh:"1"}};x("amazonConfig",e);const t=Date.now();apstag.fetchBids(e,(function(e){const i=Date.now()-t;x(`Amazon response time: ${i}ms`),e.forEach((e=>{p.amazon[e.slotID]={value:e.amznbid,size:e.size,responseTime:i+"ms",error:e.error||null}})),x("Amazon bids received:",p.amazon),apstag.setDisplayBids(),a.apsBidsReceived=!0,a.dmBidsReceived&&(o(),x(`refresh() with amazon fetch: ${s.map((e=>e.slotID.replace("mai-ad-",""))).join(", ")}`,s)),(u||g)&&e.forEach((e=>{e.error&&x("apstag.fetchBids error:",e)}))}))}else t.length&&(a.apsBidsReceived=!0,a.dmBidsReceived&&(o(),x(`refresh() without amazon slots to fetch: ${t.map((e=>e.getSlotElementId())).join(", ")}`,t)))}else{if(!t.length)return;a.apsBidsReceived=!0,a.dmBidsReceived&&o(),x(`refresh() with GAM: ${t.map((e=>e.getSlotElementId())).join(", ")}`,t)}setTimeout((()=>{const e={adserverRequestSent:a.adserverRequestSent,dmBidsReceived:a.dmBidsReceived,apsBidsReceived:a.apsBidsReceived,prebidBids:p.prebid,amazonBids:p.amazon,timeouts:p.timeouts,timing:{totalTime:Date.now()-v,bidderTimeout:l,fallbackTimeout:m}};a.adserverRequestSent||x("refresh() with failsafe timeout. Debug data:",e),o()}),m)}function M(e){return e&&t.includes(e.getAdUnitPath())}function $(e){return M(e)&&Boolean(e.getTargeting(s).shift())}function j(e){maiPubAdsVars.amazonUAM&&(x(`setDisplayBids via apstag: ${e.map((e=>e.getSlotElementId())).join(", ")}`,e),apstag.setDisplayBids()),googletag.pubads().refresh(e,{changeCorrelator:!1})}function x(...e){if(!u&&!g)return;let t="maipub ";const a=Date.now(),i=(new Date).toLocaleTimeString("en-US",{hour12:!0});t+=v===a?"start":a-v+"ms",console.log(`${t} ${i}`,e)}})();
//# sourceMappingURL=mai-publisher-ads.js.map